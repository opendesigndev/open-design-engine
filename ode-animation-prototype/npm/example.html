<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Animation Prototype | Open Design Engine</title>
</head>
<body>
    <canvas id="canvas" width="640" height="480"></canvas>
    <script id="octopus" type="application/json">{"type":"OCTOPUS_COMPONENT","version":"3.0.0-alpha.33","id":"OCTOPUS1","dimensions":{"width":640,"height":480},"content":{"id":"ROOT1","type":"GROUP","name":"Root","visible":true,"opacity":1,"blendMode":"NORMAL","transform":[1,0,0,1,0,0],"layers":[{"id":"SHAPE1","type":"SHAPE","name":"Shape 1","visible":true,"opacity":1,"blendMode":"NORMAL","transform":[1,0,0,1,0,0],"shape":{"path":{"type":"PATH","geometry":"M 193.287149 3.393170 L 476.025269 9.660451 L 482.682699 213.904965 L 192.292978 221.465743 Z","transform":[1,0,0,1,-100,100],"visible":true},"fills":[{"type":"COLOR","visible":true,"blendMode":"NORMAL","color":{"r":1,"g":0.5,"b":0,"a":1}}],"strokes":[{"fill":{"type":"COLOR","visible":true,"blendMode":"NORMAL","color":{"r":0.25,"g":0.25,"b":0.25,"a":1}},"thickness":6,"position":"OUTSIDE","visible":true,"style":"SOLID"}]},"effects":[{"type":"DROP_SHADOW","basis":"BODY","visible":true,"blendMode":"NORMAL","shadow":{"offset":{"x":20,"y":40},"blur":0,"choke":0,"color":{"r":0,"g":0,"b":0,"a":0.5}}}]},{"id":"SHAPE2","type":"SHAPE","name":"Shape 2","visible":true,"opacity":1,"blendMode":"NORMAL","transform":[1,0,0,1,0,0],"shape":{"path":{"type":"PATH","geometry":"M 283.078463 53.153966 L 563.101657 46.649861 L 568.693136 251.248390 L 277.516282 252.142949 Z","transform":[1,0,0,1,0,0],"visible":true},"fills":[{"type":"COLOR","visible":true,"blendMode":"NORMAL","color":{"r":0,"g":0.5,"b":1,"a":1}}],"strokes":[{"fill":{"type":"COLOR","visible":true,"blendMode":"NORMAL","color":{"r":0.25,"g":0.25,"b":0.25,"a":1}},"thickness":6,"position":"CENTER","visible":true,"style":"SOLID"}]},"effects":[{"type":"BLUR","basis":"LAYER_AND_EFFECTS","blur":4}]}],"effects":[]}}</script>
    <script id="animdef" type="application/json">{"animations":[{"layer":"SHAPE2","type":"ROTATION","keyframes":[{"delay":1,"rotation":0},{"delay":3,"rotation":5.357142857142857,"easing":[0,1]},{"delay":12,"rotation":-73,"easing":[0,1]}],"rotationCenter":[420,150]},{"layer":"SHAPE1","type":"ROTATION","keyframes":[{"delay":1,"rotation":0},{"delay":59,"rotation":-25.132741228718345,"easing":[0,1]}],"rotationCenter":[420,150]},{"layer":"SHAPE1","type":"TRANSFORM","keyframes":[{"delay":1,"transform":[2,0,0,2,0,0]},{"delay":4,"transform":[1,0,0,1,0,0],"easing":[0,1]}]},{"layer":"SHAPE1","type":"OPACITY","keyframes":[{"delay":1,"opacity":0},{"delay":4,"opacity":1,"easing":[1,1]}]}]}</script>
    <script type="module">
        import load from './ode.js'
        // note that this example intentionally skips over resource cleanup and
        // therefore leaks memory
        const ode = await load()
        console.log(ode)

        const engine_attributes = new ode.EngineAttributes();
        ode.initializeEngineAttributes(engine_attributes);
        const engine = new ode.EngineHandle();
        ode.createEngine(engine, engine_attributes);

        // design
        const design = new ode.DesignHandle();
        ode.createDesign(engine, design);
        const component = new ode.ComponentHandle();
        const component_metadata = {
            id: stringRef("OCTOPUS1"),
            page: stringRef("page_id"),
            position: [0, 0]
        };
        const octopusStringRef = stringRef(document.querySelector('#octopus').innerHTML.trim());

        ode.design_addComponentFromOctopusString(design, component, component_metadata, octopusStringRef, null);
        const animationDefinition = stringRef(document.querySelector('#animdef').innerHTML.trim())
        ode.pr1_component_loadAnimation(component, animationDefinition, null);

        
        const rendererContext = new ode.RendererContextHandle();
        ode.createRendererContext(engine, rendererContext, stringRef('#canvas'));

        const designImageBase = new ode.DesignImageBaseHandle()
        ode.createDesignImageBase(rendererContext, design, designImageBase);

        const animationRenderer = new ode.PR1_AnimationRendererHandle()
        ode.pr1_createAnimationRenderer(rendererContext, component, animationRenderer, designImageBase);

        const frameView = new ode.PR1_FrameView()
        frameView.width = 640
        frameView.height = 480
        frameView.scale = 1
        
        
        let start;
        function redraw(timestamp) {
            if (start === undefined) {
                start = timestamp;
            }
            const t = .001*(timestamp-start);
            ode.pr1_animation_drawFrame(animationRenderer, frameView, t);
            window.requestAnimationFrame(redraw)
        }
        
        window.requestAnimationFrame(redraw)

        function stringRef(str) {
            return (new ode.String(str)).ref()
        }
    </script>
</body>
</html>
